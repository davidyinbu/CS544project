---
title: "Analysis of Used Cars Catalog in Belarus"
author: "Team 21 - Zhihe Tian / Dawei Yin / Sha Hu "
date: "December 5th, 2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(plotly)
library(psych)
library("reshape2")
library(wordcloud2) 
```

## R Markdown
data set : https://www.kaggle.com/lepchenkov/usedcarscatalog

```{r cars}
#load data
car_data <- read.csv("cars.csv", encoding = "UTF-8", stringsAsFactors = T)
car_data$model_name <- as.character(car_data$model_name)
#attach(car_data)
```

## Data Set Details
The dataset is collected from various web resources in order to explore the used cars market, and the data is scraped in Belarus (western Europe) on the 2nd of December 2019.

## Goal of Analysis
We try to build a model that effectively predicts the price of the car based on its parameters (both numerical and categorical)


## Distributions of Datas 

```{r dis, echo=FALSE}

#- Year produced

p1 <- ggplot(car_data, aes(x = year_produced))+  geom_bar(aes(y = ..prop.., group = 1), fill = "grey") + geom_density(alpha=0.25, fill = "red", size = 1)
ggplotly(p1)

p2 <- ggplot(car_data, aes(x = price_usd)) + geom_histogram(aes(y=..density..), fill = "grey")+ geom_density(alpha=0.25, fill = "blue", size = 1)
ggplotly(p2)

p3 <- ggplot(car_data, aes(x = odometer_value)) +  geom_histogram(aes(y=..density..), fill = "grey")+ geom_density(alpha=0.25, fill = "green", size = 1)
ggplotly(p3)


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



```{r CLT}
CLT_odo_data <- car_data$odometer_value
outliers <- boxplot(CLT_odo_data, plot=FALSE)$out
CLT_odo_data <- CLT_odo_data[!CLT_odo_data %in% outliers]

modes <- function(d){
    i <- which(diff(sign(diff(d$y))) < 0) + 1
    data.frame(x = d$x[i], y = d$y[i])
}

#poplution mean 
mean(CLT_odo_data)


samples <- 10000
#sample size
par(frow = c(2,2))
sample.size <- c(10,20,30,40)
xbar <- matrix(nrow = samples,ncol = 4)
#4*1000
for(j in (1:length(sample.size))){
  for( i in 1:samples){
    xbar[i,j] <- mean(sample(CLT_odo_data, size = sample.size[j],replace =T))
    }
  #densplot <- ggplot(mapping  = aes(xbar[,j])) + geom_density()
# print(ggplotly(densplot))
}

s10 <- as.data.frame(xbar[,1])
colnames(s10)<- "size10"

s20 <- as.data.frame(xbar[,2])
colnames(s20)<- "size20"

s30 <- as.data.frame(xbar[,3])
colnames(s30)<- "size30"

s40 <- as.data.frame(xbar[,4])
colnames(s40)<- "size40"

ss <- data.frame(s10 = s10, s20 = s20, s30=s30,s40=s40)

mean(ss[,1])
mean(ss[,2])
mean(ss[,3])
mean(ss[,4])
describe(ss)

sss <- gather(ss)


#plot_densi <- ggplot() + geom_density(aes(x = val1), data = s10, colour = "red") + 
 # geom_density(aes(x = val2), data = s20, colour = "green1") + 
  #geom_density(aes(x = val3), data = s30,  colour = "blue") +
  #geom_density(aes(x = val4), data = s40,colour = "orange3")+
  #scale_color_manual(name = "dsad") + 
  #theme(legend.position = c(0, 1),legend.justification = c(0, 1))

plot_densi <- ggplot(sss, aes(x = value, fill = key)) +
  geom_density(kernel = "gaussian", alpha = 0.1)
ggplotly(plot_densi)

```




```{r sampling}
library(sampling)

library(sampling)
#srswr
set.seed(544)

s <- srswr(1000, length(CLT_odo_data))
s[s != 0]

rows <- (1:length(CLT_odo_data))[s!=0]
rows <- rep(rows, s[s != 0])
rows

sample.1 <- CLT_odo_data[rows]

hist(sample.1)


#systematic

N <- length(CLT_odo_data)
n <- 1000

k <- ceiling(N / n)
k

r <- sample(k, 1)
r


s <- seq(r, by = k, length = n)

sample.2 <- CLT_odo_data[s]

hist(sample.2)

#stratified
len<-length(CLT_odo_data)
section.ids <- rep(LETTERS[1:25], each = len/25)

section.odo <- CLT_odo_data[1:length(section.ids)]

data <- data.frame(
  Section = section.ids, 
  odo = section.odo)

head(data)

table(data$Section)

st.1 <- sampling::strata(data, stratanames = c("Section"),
                         size = rep(25,40), method = "srswor",
                         description = TRUE)

st.1

st.sample1 <- getdata(data, st.1)

par(mfrow = c(2,2))
hist(CLT_odo_data)
hist(sample.1)
hist(sample.2)
hist(st.sample1$odo)
par(mfrow = c(1,1))

```





```{r top10}

top<-sort(table(car_data$manufacturer_name),decreasing = T)[1:10]
top_names <- names(top)
car_data_other <- car_data%>%mutate(pie_ca = ifelse(manufacturer_name %in% top_names,
                                             yes = as.character(manufacturer_name), "other"))

pie_data <- as.data.frame(table(car_data_other$pie_ca)); colnames(pie_data)<-c("Brand","Freq")

pie_data <- pie_data%>%arrange(desc(Brand))%>%mutate(prop = Freq /sum(pie_data$Freq)*100)%>%mutate(ypos = cumsum(prop)- 0.5*prop )

  
#pie chart
plot_ly(data = pie_data, labels = ~Brand, values=~Freq,type="pie")%>%
  layout(title = "TOP10 sell Car Brand")

#word cloud
#word_data <- pie_data[1:2];colnames(word_data) <- c("word", "freq")
#wordcloud2(data=pie_data, size=1.6)




```

```{r bodycolor}
pie_data_color<- as.data.frame(table(car_data_other$color))
colnames(pie_data_color)<-c("Color","Freq")

plot_ly(data = pie_data_color, labels = ~Color, values=~Freq,type="pie")%>%
  layout(title = "Body color")
```

```{r bodytype}
pie_data_type<- as.data.frame(table(car_data_other$body_type))
colnames(pie_data_type)<-c("Type","Freq")

plot_ly(data = pie_data_type, labels = ~Type, values=~Freq,type="pie")%>%
  layout(title = "Body type")
```

```{r year_trends}


#
#vis transimission
p_t_1 <- ggplot(data = car_data, aes(x = year_produced, fill = transmission)) + geom_histogram(color = "grey")+
coord_flip()
ggplotly(p_t_1)



#vis Engine_fuel 
p_t_2 <- ggplot(data = car_data, aes(x = year_produced, fill = engine_fuel)) + geom_histogram(color = "grey")+
coord_flip()
ggplotly(p_t_2)


#Warranty 
p_t_3 <- ggplot(data = car_data, aes(x = year_produced, fill = has_warranty)) + geom_histogram(color = "grey")+
coord_flip()
ggplotly(p_t_3)


```


```{r q2}

#
V_car <- car_data_other%>%filter(pie_ca == "Volkswagen")
V_car$model_name <- as.character(V_car$model_name)


V_car_top5 <- sort(table(V_car$model_name),decreasing = T)
V_car_top5_names <- names(V_car_top5)[1:5]
other <- data.frame(Model="other", Freq = sum(V_car_top5[6:length(V_car_top5)]))
#V_car_top5%>%add_row(Model = "other", Freq = sum(V_car_top5[6:length(V_car_top5)]))
V_car_top5 <- as.data.frame(V_car_top5); colnames(V_car_top5) <- c("Model", "Freq")
V_car_top5<- V_car_top5[1:5,]
V_car_top5 <- rbind(V_car_top5, other)

plot_ly(data = V_car_top5, labels = ~Model, values=~Freq,type="pie")%>%
  layout(title = "TOP5 most popular of Volkswagen")

```




```{r p2cont}

Top_5_v_dataset <- V_car%>%filter(model_name %in% V_car_top5_names )
Top_5_v_dataset$model_name <- as.character(Top_5_v_dataset$model_name)
Top_5_v_dataset$model_name <- as.factor(Top_5_v_dataset$model_name)

Top_5_v_dataset <- as.data.frame(Top_5_v_dataset)

#
plot_ly(Top_5_v_dataset, y = ~model_name, x = ~price_usd) %>%
  add_boxplot(color = ~model_name)



#
plot_22 <- ggplot(Top_5_v_dataset,aes( x= odometer_value)) + geom_histogram(aes(fill = model_name)) + facet_grid(model_name~.)
ggplotly(plot_22)




#
Top_5_by_year <- Top_5_v_dataset%>%group_by(model_name,year_produced)%>%count()
Top_5_by_year <-  pivot_wider(Top_5_by_year, names_from = model_name,values_from = n)

Top_5_by_year[is.na(Top_5_by_year)] <- 0
plot_23 <- Top_5_by_year %>%
    gather(key,number, Golf, Jetta,Passat,T4,Touran) %>%
    ggplot(aes(x=year_produced, y=number, colour=key)) +
    geom_point() + geom_line() 
ggplotly(plot_23)

```


```{r bubble}
names(V_car_top5) <- c("model_name", "Freq")
Top_5_v_dataset <- merge(Top_5_v_dataset,V_car_top5, by  = "model_name")

bubble_1 <- Top_5_v_dataset %>% arrange(desc(model_name)) %>% ggplot(aes(x=year_produced, y=odometer_value, size = price_usd, color = model_name)) + geom_point(alpha=0.25) 

ggplotly(bubble_1)

```
